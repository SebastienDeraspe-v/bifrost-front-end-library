import { Meta } from '@storybook/addon-docs/blocks';
import ImageComponentAPIDebug from './images/component-api-debug.png';
import ImageComponentPathDebug from './images/component-path-debug.png';

<Meta
    title='Implementation/Drupal'
    parameters={{ 
        layout: 'padded', 
        viewMode: 'docs',
        previewTabs: { canvas: { hidden: true } }
    }}
/>

# Drupal implementation
You have a **Drupal installation** and you want to use Bifrost Design System.

<br/><br/>

## Requirements
- **Twig v1.x** (impossible to upgrade...)
- **Drupal** requirements?
- **Simphony** requirements?
- ...

## Migration
First Step: Create a branch and run your Drupal website on this branch.
<br/>

### Visual regression Test
In order to avoid visual regression, we could use **[Backstopjs](https://github.com/garris/BackstopJS)**. This will create snapshots of your website and compare the diff.
<br/>

**Notes about BackStopJS**
- üëç You can reproduce user action (hover, click, ...) and responsive behavior.
- üëç In the config, you will be able to test in different browsers.
- üëé You enter urls manualy.
- üëé Snapshots are not display on a public URL. However they can be retrieve in GIT.
- üôÇ But feel free to use the Visual regression Test that is the more relevant to you.
- üöÄ In the futur, you could add theses tests in your CI.
<br/><br/>

**Let's install it**
- Install BackStopJS: `npm install -g backstopjs`.
- Then go to your **theme** directory and run `backstop init`.
This will create a **backstop** folder with a default config inside.
- Open **backstop.json** and change the url of the scenario.
Then run `backstop reference` to create a first snapshots reference of this URL.

> Relevant article: [Integration Drupal and BackstopJS](https://medium.com/limoengroen/integrating-backstopjs-in-our-drupal-updates-workflow-part-1-683da08bb629)
>
> **FYI**, Design System visual regressions are validated thanks to [Chroma](https://www.chromatic.com/).


## 1. Install the package
In the Drupal Theme.
```Shell
npm install bifrost-front-end-library --save
```

## 2. Create Namespace @components
[Install components module](https://www.drupal.org/project/components) in Drupal. This will create **namespace/shortcut** to the NPM Package.
Then, add theses paths to **your-theme.info.yml**:
```
component-libraries:
  components:
    paths:
      - node_modules/bifrost-front-end-library/source/components/
  organisms:
    paths:
      - node_modules/bifrost-front-end-library/source/organisms/
  templates:
    paths:
      - node_modules/bifrost-front-end-library/source/templates/
  bifrostUtils:
    paths:
      - node_modules/bifrost-front-end-library/source/
```

## 3. Swith for the new CSS
Create a library **your-theme.libraries.yml**:
```js
global-styling:
  css:
    theme:
        styles.css: {}
        'node_modules/bifrost-front-end-library/source/style.min.css': {}
```

Then, add this library to **your-theme.info.yml**:
```js
libraries:
  - your-theme/global-styling
```

## 4. Migrate Components

**üëâ We will start with the Button component.**

### Components Path
- In your terminal, go to: **node_modules/bifrost-front-end-library**.
- Then run `npm run bf:migrate-twig-path` to replace all path to PatternLab with the new architecture.
<img src={ImageComponentPathDebug} style={{maxWidth: '800px'}} />

### Component API
- Create a environment variable `environment = 'dev'` 
- Twig files will then display unused properties in the console:
<img src={ImageComponentAPIDebug} style={{maxWidth: '600px'}} />
- Fix component API with the help of Storybook.

## 5. Test Visual Regression
- Check manually the differences in your localhost.
- Run `backstop test` to compare snapshots.

## 6. Issues
- 1. **Issues with a component** (basically, component property or CSS issues.) 
=> Please, flag on Slack channel => Videotron fix the issue or AppNovation could suggest a PR in the design system with David in review.
- 2. **Issues with the website** => AppNovation fix the issue.
